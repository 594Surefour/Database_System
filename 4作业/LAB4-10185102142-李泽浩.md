## <center>作业4-10185102142-李泽浩



##### （1）统计所有部门的员工数目，输出部门名称和其员工数目。注：使用外连接，保证输出所有部门。

```sql
SELECT d.DEPT_ID, COUNT(e.EMP_ID) as numbers
FROM department as d LEFT JOIN employee as e on d.DEPT_ID = e.DEPT_ID
GROUP BY d.DEPT_ID;
```

<img src="截屏2021-04-12 下午3.02.02.png" alt="截屏2021-04-12 下午3.02.02" style="zoom:50%;" />

##### （2）查询交易历史表(acc_transaction)里所有交易对应执行交易的出纳员编号(TELLER_EMP_ID)和交易对应账户的开户员工编号

```sql
SELECT t.TELLER_EMP_ID, a.OPEN_EMP_ID
FROM account as a,acc_transaction as t
WHERE a.ACCOUNT_ID = t.ACCOUNT_ID;
```

<img src="截屏2021-04-12 下午3.19.54.png" alt="截屏2021-04-12 下午3.19.54" style="zoom: 33%;" />



<img src="截屏2021-04-12 下午3.20.09.png" alt="截屏2021-04-12 下午3.20.09" style="zoom:33%;" />

##### （3）查询位于“上海市”的客户的单位联系人信息，输出其姓名、职位和在职时间（使用START_DATE字段计算）。

```sql
SELECT CONCAT(o.LAST_NAME,o.FIRST_NAME) as name, o.TITLE, DATEDIFF(CURDATE(),o.START_DATE)/365 as "time 单位:年"
FROM customer as c, officer as o
WHERE c.ADDRESS LIKE "上海市%"
	and c.CUST_ID = o.CUST_ID;
```

<img src="截屏2021-04-12 下午3.25.53.png" alt="截屏2021-04-12 下午3.25.53" style="zoom:50%;" />



导入course.sql并完成以下两个题目（第4题和第5题），C_ID和P_ID分别为课程号和前期必修课程号。

##### （4）利用函数，实现用迭代输出某个课程（作为函数输入）的所有前期必修课程号（包含本课程的课程号），用'&'隔开，按照先父后子的顺序输出，请勿输出多余符号。输入以下指令以查看结果。

```sql
CREATE DEFINER = CURRENT_USER FUNCTION class(id varchar(255))  RETURNS varchar(255)
BEGIN
  DECLARE res VARCHAR(255) DEFAULT('');
	DECLARE temp VARCHAR(255) DEFAULT(id);
	WHILE temp IS NOT NULL DO
		IF(res == '')	THEN
			set res = CONCAT(temp,res);
		ELSE 
		  set res = CONCAT(temp,'&',res);
		END IF;
		SELECT GROUP_CONCAT(P_ID) INTO temp
            FROM course
            WHERE FIND_IN_SET(C_ID, temp) > 0;
	END WHILE;
RETURN res;
END;
```



##### （5）利用函数，实现用迭代输出某个课程（作为函数输入）的所有后续可修课程号（包含本课程的课程号），用' , '隔开，请勿输出多余符号。输入以下指令以查看结果

```sql
CREATE DEFINER = CURRENT_USER FUNCTION getNext(id VARCHAR(255)) RETURNS varchar(255) 
BEGIN
  	DECLARE res VARCHAR(255) DEFAULT('');
		DECLARE temp VARCHAR(255) DEFAULT(id);
    WHILE temp IS NOT NULL DO
            IF res='' THEN
                SET res = CONCAT(res, temp);
            ELSE
                SET res = CONCAT(res, ' , ', temp);
            END IF;
            SELECT GROUP_CONCAT(C_ID) INTO  temp 
            FROM course
            WHERE FIND_IN_SET(P_ID, temp) > 0;
    END WHILE;
    RETURN res;
END
```



##### （6）定义视图v_getEmpHeadOffice，定义时候使用with check option子句，从employee表中找出ASSIGNED_BRANCH_ID为1（即所在分支机构为“上海市总行”）的员工信息，输出名、姓、开始/就职日期、职位名称、所在分支结构编号、所在部门编号、上机领导编号。输入下面的指令往该视图中插入数据，能否成功？为什么？

insert into v_getempheadoffice values('志文','王','2021-01-01','出纳员',2,1,4)

```sql
#创建视图
CREATE VIEW v_getEmpHeadOffice AS
SELECT first_name, last_name, start_date, title, ASSIGNED_BRANCH_ID
				,superior_emp_id, dept_id
FROM employee
WHERE ASSIGNED_BRANCH_ID=1
WITH CHECK OPTION;
```

执行插入操作后报错如下：

<img src="截屏2021-04-12 下午3.38.06.png" alt="截屏2021-04-12 下午3.38.06" style="zoom:50%;" />

不能成功，因为插入的数据中ASSIGNED_BRANCH_ID为2，不满足限制条件，插入后不能通过视图看到修改后的数据。



##### （7）定义视图v_getCustbyProCount，从account表中找出购买产品数量超过2个的客户，输出属性包括账户编号（CUST_ID）、该账户购买产品个数（命名为Count_Acc）、该账户各产品可用余额总数（命名为Sum_Avail_Balance）、该账户各产品可用余额平均数（命名为 Avg_Avail_Balance）。

```sql
CREATE VIEW v_getCustbyProCount AS
SELECT CUST_ID, 
			avg(AVAIL_BALANCE) as "Avg_Avail_Balance",
		  sum(AVAIL_BALANCE) as "Sum_Avail_Balance",
			count(DISTINCT PRODUCT_CD) as "Count_Acc"
FROM account
GROUP BY CUST_ID
HAVING Count_Acc > 2;
```

<img src="截屏2021-04-12 下午3.59.42.png" alt="截屏2021-04-12 下午3.59.42" style="zoom:50%;" />



##### <img src="截屏2021-04-12 下午7.34.07.png" alt="截屏2021-04-12 下午7.34.07" style="zoom:50%;" />

##### （8）定义存储过程getEmpInfobyDept，接收输入参数DEPT_ID，列出属于指定部门编号的员工信息，输出属性包括员工编号EMP_ID、姓名（LAST_NAME与FIRST_NAME拼接）、开始/就职日期（START_DATE）、职位名称（TITLE）、所在分支机构名称（NAME）、上级领导姓名（LAST_NAME与FIRST_NAME拼接）

```sql
DROP PROCEDURE getEmpInfobyDept;

CREATE PROCEDURE getEmpInfobyDept(IN d_id INT)
BEGIN

	SELECT e1.EMP_ID, CONCAT(e1.LAST_NAME,e1.FIRST_NAME) as all_name,
				DATEDIFF(CURRENT_DATE,e1.START_DATE)/365 as time,
				e1.TITLE,b.`NAME`,
				CONCAT(e2.LAST_NAME,e2.FIRST_NAME) as sup_name
	FROM	employee as e1, employee as e2, branch as b
	WHERE e1.DEPT_ID = d_id
	      AND e1.ASSIGNED_BRANCH_ID = b.BRANCH_ID
				AND e1.SUPERIOR_EMP_ID = e2.EMP_ID
			UNION
	SELECT e1.EMP_ID, CONCAT(e1.LAST_NAME,e1.FIRST_NAME) as all_name,
				DATEDIFF(CURRENT_DATE,e1.START_DATE)/365 as time,
				e1.TITLE,b.`NAME`, NULL
	FROM	employee as e1, employee as e2, branch as b
	WHERE e1.DEPT_ID = d_id
	      AND e1.ASSIGNED_BRANCH_ID = b.BRANCH_ID
				AND ISNULL(e1.SUPERIOR_EMP_ID);
END;

#以下用于检验
CALL getEmpInfobyDept (3);
CALL getEmpInfobyDept (2);
CALL getEmpInfobyDept (1);
```

<img src="截屏2021-04-12 下午8.46.39.png" alt="截屏2021-04-12 下午8.46.39" style="zoom:50%;" />

<img src="截屏2021-04-12 下午8.43.40.png" alt="截屏2021-04-12 下午8.43.40" style="zoom:50%;" />

<img src="截屏2021-04-12 下午8.43.51.png" alt="截屏2021-04-12 下午8.43.51" style="zoom:50%;" />

