## <center>作业4-10185102142-李泽浩



##### （1）统计所有部门的员工数目，输出部门名称和其员工数目。注：使用外连接，保证输出所有部门。

```sql
SELECT NAME,COUNT(EMP_NAME)
FROM(
SELECT CONCAT(LAST_NAME,FIRST_NAME) AS EMP_NAME, NAME
FROM department NATURAL LEFT OUTER JOIN employee) AS t
GROUP BY NAME
```

<img src="截屏2021-04-12 下午3.02.02.png" alt="截屏2021-04-12 下午3.02.02" style="zoom:50%;" />

##### （2）查询交易历史表(acc_transaction)里所有交易对应执行交易的出纳员编号(TELLER_EMP_ID)和交易对应账户的开户员工编号

```sql
SELECT TXN_ID,TELLER_EMP_ID,OPEN_EMP_ID
FROM acc_transaction JOIN account USING(ACCOUNT_ID)
```

<img src="截屏2021-04-12 下午3.19.54.png" alt="截屏2021-04-12 下午3.19.54" style="zoom: 33%;" />



<img src="截屏2021-04-12 下午3.20.09.png" alt="截屏2021-04-12 下午3.20.09" style="zoom:33%;" />

##### （3）查询位于“上海市”的客户的单位联系人信息，输出其姓名、职位和在职时间（使用START_DATE字段计算）。

```sql
SELECT CONCAT(LAST_NAME,FIRST_NAME),TITLE,TIMESTAMPDIFF(YEAR, START_DATE, CURDATE())
FROM officer JOIN customer USING(CUST_ID)
WHERE CITY="上海市"
```

<img src="截屏2021-04-12 下午3.25.53.png" alt="截屏2021-04-12 下午3.25.53" style="zoom:50%;" />



导入course.sql并完成以下两个题目（第4题和第5题），C_ID和P_ID分别为课程号和前期必修课程号。

##### （4）利用函数，实现用迭代输出某个课程（作为函数输入）的所有前期必修课程号（包含本课程的课程号），用'&'隔开，按照先父后子的顺序输出，请勿输出多余符号。输入以下指令以查看结果。

```sql
CREATE DEFINER = CURRENT_USER FUNCTION class(id varchar(255))  RETURNS varchar(255)
varchar(50) CHARSET utf8mb4 COLLATE utf8mb4_general_ci
BEGIN
      DECLARE result VARCHAR(50);
      DECLARE pretemp VARCHAR(50);
      SET result = '';
      SET pretemp = cid;
    WHILE pretemp IS NOT NULL DO
            IF result = '' THEN
                SET result = CONCAT(pretemp,result);
            ELSE
                SET result = CONCAT(pretemp, ' & ',result);
            END IF;
            SELECT GROUP_CONCAT(P_ID) INTO pretemp
            FROM course
            WHERE FIND_IN_SET(C_ID, pretemp) > 0;
    END WHILE;
    RETURN result;
END

```



##### （5）利用函数，实现用迭代输出某个课程（作为函数输入）的所有后续可修课程号（包含本课程的课程号），用' , '隔开，请勿输出多余符号。输入以下指令以查看结果

```sql
CREATE DEFINER=`root`@`localhost` FUNCTION `getNext`(cid VARCHAR(100)) RETURNS varchar(100) CHARSET utf8mb4 COLLATE utf8mb4_general_ci
BEGIN
      DECLARE result VARCHAR(100);
      DECLARE nexttemp VARCHAR(100);
      SET result = '';
      SET nexttemp = cid;
    WHILE nexttemp IS NOT NULL DO
            IF result='' THEN
                SET result = CONCAT(result, nexttemp);
            ELSE
                SET result = CONCAT(result, ' , ', nexttemp);
            END IF;
            SELECT GROUP_CONCAT(C_ID) INTO  nexttemp 
            FROM course
            WHERE FIND_IN_SET(P_ID, nexttemp) > 0;
    END WHILE;
    RETURN result;
END
```



##### （6）定义视图v_getEmpHeadOffice，定义时候使用with check option子句，从employee表中找出ASSIGNED_BRANCH_ID为1（即所在分支机构为“上海市总行”）的员工信息，输出名、姓、开始/就职日期、职位名称、所在分支结构编号、所在部门编号、上机领导编号。输入下面的指令往该视图中插入数据，能否成功？为什么？

insert into v_getempheadoffice values('志文','王','2021-01-01','出纳员',2,1,4)

```sql
CREATE VIEW v_getEmpHeadOffice AS
SELECT
    `employee`.`FIRST_NAME` AS `FIRST_NAME`,
    `employee`.`LAST_NAME` AS `LAST_NAME`,
    `employee`.`START_DATE` AS `START_DATE`,
    `employee`.`TITLE` AS `TITLE`,
    `employee`.`ASSIGNED_BRANCH_ID` AS `ASSIGNED_BRANCH_ID`,
    `employee`.`DEPT_ID` AS `DEPT_ID`,
    `employee`.`SUPERIOR_EMP_ID` AS `SUPERIOR_EMP_ID` 
FROM
    `employee` 
WHERE
    ( `employee`.`ASSIGNED_BRANCH_ID` = 1 )
WITH CHECK OPTION;
```

执行插入操作后报错如下：

<img src="截屏2021-04-12 下午3.38.06.png" alt="截屏2021-04-12 下午3.38.06" style="zoom:50%;" />

不能成功，因为插入的数据中ASSIGNED_BRANCH_ID为2，不满足限制条件，插入后不能通过视图看到修改后的数据。



##### （7）定义视图v_getCustbyProCount，从account表中找出购买产品数量超过2个的客户，输出属性包括账户编号（CUST_ID）、该账户购买产品个数（命名为Count_Acc）、该账户各产品可用余额总数（命名为Sum_Avail_Balance）、该账户各产品可用余额平均数（命名为 Avg_Avail_Balance）。

```sql
CREATE VIEW v_getCustbyProCount AS
SELECT CUST_ID,COUNT(PRODUCT_CD) AS CountAcc,SUM(AVAIL_BALANCE) AS Sum_Avail_Balance,AVG(AVAIL_BALANCE) AS Avg_Avail_Balance
FROM account
GROUP BY CUST_ID
HAVING COUNT(PRODUCT_CD)>2;
```

<img src="截屏2021-04-12 下午3.59.42.png" alt="截屏2021-04-12 下午3.59.42" style="zoom:50%;" />



##### <img src="截屏2021-04-12 下午7.34.07.png" alt="截屏2021-04-12 下午7.34.07" style="zoom:50%;" />

##### （8）定义存储过程getEmpInfobyDept，接收输入参数DEPT_ID，列出属于指定部门编号的员工信息，输出属性包括员工编号EMP_ID、姓名（LAST_NAME与FIRST_NAME拼接）、开始/就职日期（START_DATE）、职位名称（TITLE）、所在分支机构名称（NAME）、上级领导姓名（LAST_NAME与FIRST_NAME拼接）

```sql
CREATE DEFINER=`root`@`localhost` PROCEDURE `getEmpInfobyDept`(IN dept int)
BEGIN
  (SELECT e1.EMP_ID,CONCAT(e1.LAST_NAME,e1.FIRST_NAME),e1.START_DATE,e1.TITLE,b.NAME,CONCAT(e2.LAST_NAME,e2.FIRST_NAME)
    FROM employee as e1,branch as b,employee as e2
    WHERE e1.DEPT_ID=dept AND e1.ASSIGNED_BRANCH_ID=b.BRANCH_ID AND (e1.SUPERIOR_EMP_ID=e2.EMP_ID)
    )UNION(
    SELECT e1.EMP_ID,CONCAT(e1.LAST_NAME,e1.FIRST_NAME),e1.START_DATE,e1.TITLE,b.NAME,NULL
    FROM employee as e1,branch as b
    WHERE e1.DEPT_ID=dept AND e1.ASSIGNED_BRANCH_ID=b.BRANCH_ID AND ISNULL(e1.SUPERIOR_EMP_ID));
END
```

<img src="截屏2021-04-12 下午8.46.39.png" alt="截屏2021-04-12 下午8.46.39" style="zoom:50%;" />

<img src="截屏2021-04-12 下午8.43.40.png" alt="截屏2021-04-12 下午8.43.40" style="zoom:50%;" />

<img src="截屏2021-04-12 下午8.43.51.png" alt="截屏2021-04-12 下午8.43.51" style="zoom:50%;" />

