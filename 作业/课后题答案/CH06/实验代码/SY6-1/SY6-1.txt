create database articlesale;
use articlesale;
create table article(
  articleid char(5) primary key,
  articlename varchar(40),
  articleprice decimal(15,2),
  articlecount int unsigned
)engine=innodb;


create table customer(
  customerid char(5) primary key,
  customername varchar(20),
  customersex char(2),
  customerage int unsigned
)engine=innodb;


create table orderitem(
  itemid int auto_increment primary key,
  customerid char(5),
  articleid char(5),
  ordercount int unsigned,
  itemdate datetime,
  constraint order_customer_fk foreign key(customerid) references customer(customerid),
  constraint order_article_fk foreign key(articleid) references article(articleid)  
)engine=innodb;


insert into article values("00001","商品1",34.56,200);
insert into article values("00002","商品2",105.00,100);

insert into customer values("10001","顾客1","男",20);
insert into customer values("10002","顾客2","女",34);

delimiter $$
create procedure articlesale_proc(in customerid char(5), in orderarticleid char(5), in ordercount int, out state int)
modifies sql data
begin
declare continue handler for 1264
begin  
  rollback;
  set state=-1;
end;
set state=1;
start transaction;
insert into orderitem values(null,customerid,orderarticleid,ordercount,now());
update article set articlecount=articlecount-ordercount where articleid=orderarticleid;
commit;
end
$$
delimiter ;


set @customerid="10001";
set @orderarticleid="00002";
set @ordercount=50;
set @state=0;
call articlesale_proc(@customerid, @orderarticleid, @ordercount, @state);
select * from orderitem;
select * from article;


set @customerid="10001";
set @orderarticleid="00002";
set @ordercount=80;
set @state=0;
call articlesale_proc(@customerid, @orderarticleid, @ordercount, @state);
select * from orderitem;
select * from article;
